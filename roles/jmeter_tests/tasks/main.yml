- name: Create results directory
  file:
    path: results
    state: directory
    mode: "0777"

- name: "Deploy JMeter"
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'jmeter-deployment.yml') | from_yaml }}"
    wait: true

- name: "Wait for JMeter Job to complete"
  kubernetes.core.k8s_info:
    api_version: batch/v1
    kind: Job
    name: jmeter-airtrail-test
    namespace: default
    wait: true
    wait_sleep: 10
    wait_timeout: 600

- name: Get JMeter pod name
  command: kubectl get pods --selector=job-name=jmeter-airtrail-test -o jsonpath='{.items[0].metadata.name}'
  register: jmeter_pod

- name: Copy JMeter results from pod
  command: kubectl cp {{ jmeter_pod.stdout }}:/tests ./results

- name: Extract statistics to text file
  shell: |
    python3 << 'EOF'
    import json

    with open('results/report/statistics.json', 'r') as f:
      stats = json.load(f)

    with open('results/statistics.txt', 'w') as out:
      out.write("=== JMeter Test Statistics ===\n")
      out.write("Test: {{ jmeter_test_file }}\n")
      out.write("Date: $(date)\n\n")
      
      for transaction, data in stats.items():
        out.write(f"\n{transaction}:\n")
        out.write(f"  Sample Count: {data['sampleCount']}\n")
        out.write(f"  Error Count: {data['errorCount']}\n")
        out.write(f"  Error %: {data['errorPct']}\n")
        out.write(f"  Mean Response Time: {data['meanResTime']}ms\n")
        out.write(f"  Median Response Time: {data['medianResTime']}ms\n")
        out.write(f"  Min Response Time: {data['minResTime']}ms\n")
        out.write(f"  Max Response Time: {data['maxResTime']}ms\n")
        out.write(f"  Throughput: {data['throughput']} req/sec\n")
        out.write(f"  Received KB/sec: {data['receivedKBytesPerSec']}\n")
        out.write(f"  Sent KB/sec: {data['sentKBytesPerSec']}\n")
    EOF
  register: stats_output

- name: Display statistics file
  debug:
    msg: "{{ lookup('file', 'results/statistics.txt') }}"

- name: Clean up results directory
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - results/report
    - results/jmeter_results.jtl
    - results/jmeter.log

- name: Verify statistics file exists
  stat:
    path: results/statistics.txt
  register: stats_file
